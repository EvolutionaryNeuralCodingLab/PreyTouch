<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arena</title>
    <script src="{{ url_for('static', filename='jquery.js') }}" type="text/javascript"></script>
    <!--        <script type="text/javascript" src="{{ url_for('static', filename='popper.min.js') }}"></script>-->
    <script crossorigin="anonymous"
            integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css"
          rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
    <link href="{{ url_for('static', filename='bootstrap-4.5.0/css/bootstrap.css')}}" rel="stylesheet">
    <script src="{{ url_for('static', filename='Bootstrap-4-Multi-Select-BsMultiSelect/dist/js/BsMultiSelect.js') }}"
            type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="{{ url_for('static', filename='fields.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='WebSocketClient.js') }}" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.css" rel="stylesheet">
</head>

<body>
<div class="row">
    <div class="col-xl-7">
        <h1 class="p-2" style="font-size: 4em; text-align: center; margin-bottom: 0.5em">Pogona Pursuit</h1>
        <div class="row top-border bottom-border" id="all-panels">
            <div class="col-md-5 control-panel right-border">
                {% include "management/control_metrics.html" %}
            </div>
            <div class="col control-panel">
                {% include "management/cameras_record.html" %}
            </div>
        </div>
        <pre class="row" id="record-output"></pre>
    </div>
    <div class="col">
        {% include "management/stream.html" %}
        <button id="clearOutputButton" class="btn btn-secondary" style="position: relative;left: 0; top: 90px">
            <i class="fa fa-eraser"></i>
        </button>
    </div>
    {% include "management/footer.html" %}
</div>

</body>

<script>
    $(function () {
        let wsclient = new WebSocketClient('ws://127.0.0.1:6380', {
            reconnectEnabled: true,
            reconnectInterval: 5000 // time to reconnect in milliseconds
        })
        wsclient.onError = (event) => {
            appendOutput('Error connecting to Redis', color='red')
        }
        wsclient.connect()
        wsclient.subscribe({
            "{{log_channel}}": (msg) => {
                appendOutput(msg)
            }
        })
        const maxBlocks = Number("{{max_blocks}}")
        const cameras = "{{ cameras|join(',') }}".split(',')
        const $numBlocks = $("#numBlocks")
        const apiCheckTimeout = 1000
        let checkedCameras = []

        let isToggleCheckPause = false
        let api_check = function () {
            $.ajax({
                url: '/check',
                type: 'GET',
                success: function (data) {
                    if (!isToggleCheckPause) {
                        let onCameras = []
                        for (let camName in data['cam_units_status']) {
                            let tog = $(`#toggle-${camName}`)
                            let isOn = data['cam_units_status'][camName]
                            if (isOn !== tog.prop('checked')) {
                                tog.bootstrapToggle('toggle')
                            }
                            if (isOn) {
                                onCameras.push(camName)
                            }
                        }
                        // $("#selectStreamCamera option").remove()

                        $("#selectStreamCamera option").each(function () {
                            if (onCameras.indexOf(this.value) === -1) {
                                $(this).remove()
                            }
                        })
                        onCameras.forEach((camName) => {
                            if ($(`#selectStreamCamera option[value=${camName}]`).length <= 0) {
                                $("#selectStreamCamera").append($("<option></option>").attr("value", camName).text(camName))
                            }
                        })
                        $("#streamButton").prop('disabled', !onCameras.length)
                    }
                    for (let cam_name in data['cam_units_fps']) {
                        $(`#cam-fps-${cam_name}`).text(data['cam_units_fps'][cam_name]['cam_fps'].toFixed(1))
                        $(`#sink-fps-${cam_name}`).text(data['cam_units_fps'][cam_name]['sink_fps'].toFixed(1))
                        $(`#pred-fps-${cam_name}`).text(data['cam_units_fps'][cam_name]['pred_fps'].toFixed(1))
                        $(`#pred-delay-${cam_name}`).text(`${data['cam_units_fps'][cam_name]['pred_delay'].toFixed(1)}ms`)
                    }
                    for (let cam_name in data['cam_units_predictors']) {
                        $(`#predictors-${cam_name}`).text(data['cam_units_predictors'][cam_name])
                    }

                    let procText = ''
                    for (let cam_name in data['processes_cpu']) {
                        let d = data['processes_cpu'][cam_name]
                        if (!jQuery.isEmptyObject(d)) {
                            procText += `--CU-${cam_name}--` + '\n'
                            for (let procName in d) {
                                procText += `${procName}: ${d[procName]}%\n`
                            }
                        }
                    }
                    $("#procCPU").text(procText)

                    let expName = data['experiment_name']
                    let blockId = data['block_id']
                    let openAppHost = data['open_app_host']
                    let tempValue = data['temperature']
                    let tempColor = 'black'
                    if (tempValue < 27) {
                        tempColor = 'blue'
                    } else if (tempValue > 32) {
                        tempColor = 'red'
                    }
                    $("#currentExperimentName").text(expName ? `Current Experiment: ${expName}` : 'No experiment is running')
                    $("#currentBlockID").text(expName ? `Block ID: ${blockId}` : '')
                    $("#openAppHostDiv").text(openAppHost ? `pogona hunter run on: ${openAppHost}` : 'No APP is running')
                    // $("#startExperimentButton").prop('disabled', !!expName)
                    $("#temperatureValue").text(tempValue ? `Temperature: ${tempValue}Â°C` : 'No Temperature logged').css({'color': tempColor})
                    $("#gpuMetric").text(data['gpu_usage'] ? `GPU Usage: ${(data['gpu_usage']*100).toFixed(1)}%` : '')
                    $("#cpuMetric").text(data['cpu_usage'] ? `CPU Usage: ${(data['cpu_usage']).toFixed(1)}%` : '')
                    $("#memMetric").text(data['memory_usage'] ? `Memory Usage: ${(data['memory_usage']*100).toFixed(1)}%` : '')
                    $("#storageMetric").text(data['storage'] ? `Data Storage: ${(data['storage']).toFixed(0)}%` : '')
                    setTimeout(api_check, apiCheckTimeout)
                }
            })
        }
        api_check()

        let $startExpButton = $('#startExperimentButton')
        let $recordButton = $("#runRecordButton")
        let $timeBetweenBlocksDiv = $("#timeBetweenBlocksDiv")
        $startExpButton.prop('disabled', true)
        $recordButton.prop('disabled', true)
        $("streamButton").prop('disabled', true)

        cameras.forEach((cam) => {
            $(`#toggle-${cam}`).change((res) => {
                isToggleCheckPause = true
                let onRequested = $(`#toggle-${cam}`).prop('checked')
                let url = onRequested ? '/start_camera_unit' : '/stop_camera_unit'
                let camCheck$ = $(`#camera-${cam}`)
                camCheck$.prop('disabled', !onRequested)
                if (!onRequested) {
                    camCheck$.prop('checked', false)
                }
                $(`#stream-option-${cam}`).prop('disabled', !onRequested)

                $.post(url, {camera: cam}).done(function () {
                    setTimeout(() => {
                        isToggleCheckPause = false
                    }, apiCheckTimeout)
                })
            })
            $(`#camera-${cam}`).change((res) => {
                let isChecked = $(`#camera-${cam}`).prop('checked')

                const camIndex = checkedCameras.indexOf(cam)
                if (camIndex > -1 && !isChecked) {  // in checkedCameras
                    checkedCameras.splice(camIndex, 1)
                    if (checkedCameras.length === 0) {
                        $startExpButton.prop('disabled', true)
                        $recordButton.prop('disabled', true)
                    }
                } else if (camIndex === -1 && isChecked) {
                    checkedCameras.push(cam)
                    $startExpButton.prop('disabled', false)
                    $recordButton.prop('disabled', false)
                }
            })
        })

        // Number of blocks listener
        $numBlocks.change(() => {
            let numBlocks = Number($numBlocks.val())
            if (numBlocks < 2) {
                $timeBetweenBlocksDiv.hide()
            } else {
                $timeBetweenBlocksDiv.show()
            }
            for (let i = 1; i <= numBlocks; i++) {
                $(`#block${i}`).show()
            }
            for (let i = numBlocks + 1; i <= maxBlocks; i++) {
                $(`#block${i}`).hide()
            }
        }).trigger('change')

        // Inside block listeners
        for (let i = 1; i <= maxBlocks; i++) {
            // Bug types selection listener
            let $bugType = $(`#bugTypeSelect${i}`)
            let $rewardBug = $(`#rewardBugDiv${i}`)
            $bugType.bsMultiSelect()
            $bugType.change(() => {
                $(`#rewardBugSelect${i} option`).remove()
                if ($(`#bugTypeSelect${i}`).val().length <= 1) {
                    $rewardBug.hide()
                } else {
                    let $el = $(`#rewardBugSelect${i}`)
                    $(`#bugTypeSelect${i} option`).each(function (v) {
                        if (this.selected) {
                            $el.append($("<option></option>").attr("value", this.value).text(this.text)).attr('selected', true);
                        }
                    });
                    $el.bsMultiSelect("UpdateData")
                    $rewardBug.show()
                }
            })
            // circle movement is anticlockwise listener
            let $isAntiClockWiseDiv = $(`#isAntiClockWiseDiv${i}`)
            let $targetDrift = $(`#targetDrift${i}`)
            let $bugHeight = $(`#bugHeightDiv${i}`)
            // $(`#movementTypeSelect${i}`).change(function () {
            //   let movementType = $(`#movementTypeSelect${i}`).val()
            //   if (movementType === 'circle') {
            //     $isAntiClockWiseDiv.show()
            //   } else {
            //     $isAntiClockWiseDiv.hide()
            //   }
            //   if (['low_horizontal', 'low_horizontal_noise'].indexOf(movementType) !== -1) {
            //     $targetDrift.show()
            //     $bugHeight.show()
            //   } else {
            //     $targetDrift.hide()
            //     $bugHeight.hide()
            //   }
            // })
            // media or bugs experiment block
            $(`#blockTypeSelect${i}`).change(function () {
                if (isMediaExperiment(i)) {
                    $(`.media-options${i}`).show()
                    $(`.bugs-options${i}`).hide()
                } else if (isBlankExperiment(i)) {
                    $(`.media-options${i}`).hide()
                    $(`.bugs-options${i}`).hide()
                } else {
                    $(`.bugs-options${i}`).show()
                    $(`#rewardBugDiv${i}`).hide()
                    $isAntiClockWiseDiv.hide()
                    $(`.media-options${i}`).hide()
                }
            }).trigger('change')
            $(`#isDefaultBugSize${i}`).change(function () {
                if (this.checked) {
                    $(`#bugSizeDiv${i}`).hide()
                } else {
                    $(`#bugSizeDiv${i}`).show()
                }
            }).trigger('change')
        }

        $("#streamButton").click(function () {
            $.post('/set_stream_camera', {camera: $("#selectStreamCamera").val()}).done(function (camera) {
                $("#selectStreamCamera").prop("disabled", true);
                $("#calibrate").prop("disabled", true);
                $("#captureImage").prop("disabled", true);
                // $(`input[value=${camera}]`).prop("disabled", true);
                $("#stream_img").attr("src", "{{ url_for('video_feed') }}")
            })
        });

        $("#stopStream").click(function () {
            $.post('/stop_stream_camera', {camera: $("#selectStreamCamera").val()}).done(function (camera) {
                $("#stream_img").attr("src", "{{ url_for('static', filename='video_placeholder.jpg') }}")
                const sCamera = $("#selectStreamCamera");
                // $(`input[value=${sCamera.val()}]`).prop("disabled", false);
                sCamera.prop("disabled", false);
                $("#calibrate").prop("disabled", false);
                $("#captureImage").prop("disabled", false);
            })
        });

        $("#captureImage").click(function () {
           $.post('/capture', {camera: $("#selectStreamCamera").val(), folder_prefix: $("#videoOutputPrefix").val()})
        });

        $("#stopExperiment").click(function () {
            $.get('/stop_experiment', function (data) {
                console.log(data)
                console.log('wait for trial to finish...')
                $.get('/get_experiment', function (data) {
                    console.log(data)
                });
            })
        });

        $("#experiment_form").submit(function (event) {
            event.preventDefault();
            $.ajax({
                url: "/start_experiment",
                type: "POST",
                data: JSON.stringify(AllFields.values),
                contentType: "application/json",
                error: function (data) {
                    console.log(data.responseText)
                }
            })
        });

        $("#saveExperiment").click(() => {
            let params = AllFields.values
            params['name'] = $('#saveExperimentName').val()
            $.ajax({
                url: "/save_experiment",
                type: "POST",
                data: JSON.stringify(params),
                contentType: "application/json",
                beforeSend: function () {
                    console.log('>> saving experiment...')
                },
                success: function (res) {
                    console.log(`>> experiment ${params.name} was saved successfully`)
                    $('#saveExperimentModal').modal('toggle');
                },
                error: function (data) {
                    console.log(data.responseText)
                    $('#saveExperimentModal').modal('toggle');
                }
            })
        })

        $("#loadExperiment").click(() => {
            let experiment = $("#cachedExperimentsSelect").val()
            $.get(`/load_experiment/${experiment}`, (data) => {
                console.log(data)
                AllFields.values = data
                $('#loadExperimentModal').modal('toggle');
            })
        })

        $("#record_form").submit(function (event) {
            event.preventDefault();
            $.ajax({
                url: "/record",
                type: "POST",
                data: JSON.stringify(Object.assign({
                    folder_prefix: $("#videoOutputPrefix").val(),
                    cameras: Cameras.value
                }, getAcquireStop())),
                contentType: "application/json",
                beforeSend: function () {
                    console.log('recording...')
                },
                complete: function (res) {
                    console.log(res.responseText)
                }
            })
        });
        $("#stopRecord").click(function () {
            $.get("/manual_record_stop", function (data) {
                console.log(data)
            })
        })

        let $acquireStopSelect = $("#acquireStopSelect")
        $acquireStopSelect.change(function (e) {
            let acqValue = $("#acquireStopValue");
            acqValue.show()
            acqValue.prop('required', isValued);
        })
        $("#camerasInfo").click(function () {
            $.get('/cameras_info', function (data) {
                console.log(data)
            })
        })

        $("#loadMediaManual").click(function () {
            let video = $("#manualMediaSelect").val()
            $('#startMediaModal').modal('toggle');
            $.ajax({
                url: "/start_media",
                type: "POST",
                data: JSON.stringify({
                    media_url: video
                }),
                contentType: "application/json",
                complete: function (res) {
                    console.log(`>> Video ${video} started manually`)
                }
            })
        })

        $("#media_stop").click(function () {
            $.get('/stop_media', (data) => {
            })
        })

        $("#init_bugs").click(function (e) {
            let blockValues = new Block(1).values
            let payload = {
                numOfBugs: 1,
                numTrials: blockValues.num_trials,
                iti: blockValues.iti,
                trialDuration: blockValues.trial_duration,
                speed: blockValues.bug_speed,
                bugTypes: blockValues.bug_types || ['cockroach'],
                rewardBugs: blockValues.reward_bugs || [],
                movementType: blockValues.movement_type,
                backgroundColor: blockValues.background_color,
                exitHole: blockValues.exit_hole
            }
            if (!$("#isDefaultBugSize1").is(':checked')) {
                Object.assign(payload, {bugSize: Number($("#bugSize1").val())})
            }
            $.ajax({
                url: "/init_bugs",
                type: "POST",
                data: JSON.stringify(payload),
                contentType: "application/json",
                complete: function (res) {
                    console.log('>> Bugs initiated manually')
                }
            })
        })
        $("#hide_bugs").click(function (e) {
            $.get('/hide_bugs')
            console.log('>> Bugs stopped manually')
        })

        $("#calibrate").click(function (e) {
            $.post(`/calibrate`, {camera: $("#selectStreamCamera").val()}).done( function (data) {
                let bytestring = data['status']
                let image = bytestring.split('\'')[1]
                $("#stream_img").attr('src' , 'data:image/jpeg;base64,'+image)
            })
        })

        $("#reloadApp").click(function (e) {
            $.get('/reload_app')
            console.log('>> App reload command sent manually')
        })

        $("#reward").click(function (e) {
            $.get('/reward', function (data) {
                console.log('>> Reward sent manually')
            })
        })

        $("#led_light_on").click(function (e) {
            $.get('/led_light/on')
        })
        $("#led_light_off").click(function (e) {
            $.get('/led_light/off')
        })
        $("#heat_light_on").click(function (e) {
            $.get('/heat_light/on')
        })
        $("#heat_light_off").click(function (e) {
            $.get('/heat_light/off')
        })
        $("#display_on").click(function (e) {
            $.get('/display/on')
        })
        $("#display_off").click(function (e) {
            $.get('/display/off')
        })

        $("#clearOutputButton").click(function (e) {
            $("#record-output").empty()
        })

        function isMediaExperiment(i) {
            return $(`#blockTypeSelect${i}`).val() === 'media'
        }

        function isBlankExperiment(i) {
            return $(`#blockTypeSelect${i}`).val() === 'blank'
        }

        function getCheckedCameras() {
            let a = []
            $("#cams-checkboxes input").each(function (e) {
                if (this.checked && !this.disabled) {
                    a.push(this.value)
                }
            });
            return a.join(',')
        }

        function getAcquireStop() {
            let d = {};
            d[$acquireStopSelect.val()] = Number($("#acquireStopValue").val());
            return d;
        }

        function appendOutput(msg, color = 'black') {
            let container = document.createElement("div")
            let text = document.createTextNode(msg + '\n')
            container.appendChild(text)
            let msgArray = msg.split(' - ')
            if (msgArray.length >= 3) {
                switch (msgArray[2]) {
                    case 'ERROR':
                        color = 'red'
                        break
                    case 'WARNING':
                        color = 'Gold'
                        break
                    case 'EXCEPTION':
                        color = 'red'
                        break
                }
            } else {
                color = 'Indigo'
            }
            container.style.color = color
            $("#record-output").queue(function () {
                $(this).append(container).dequeue()
            })
        }

    })
</script>

<style>
    body {
        padding: 20px;
        overflow-x: hidden;
        /*overflow-y: hidden;*/
    }

    #footer {
        position: absolute;
        right: 0;
        bottom: 0;
        text-align: center;
        padding: 1em;
        z-index: -5;
    }

    .top-border {
        border-top: 1.5px solid black;
    }

    .bottom-border {
        border-bottom: 1.5px solid black;
    }

    .left-border {
        border-left: 1.5px solid black;
    }

    .right-border {
        border-right: 1.5px solid black;
    }

    .control-panel {
        padding: 1em;
    }

    .toggle {
        margin-left: 2em;
    }

    .cams-labels {
        margin-bottom: 2px;
        width: 3em;
    }

    #record-output {
        white-space: pre-wrap;
        overflow-y: auto;
        height: 250px;
        display: block;
    }

    .icon-button {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        outline: none;
        border: 0;
        background: transparent;
    }

</style>

</html>